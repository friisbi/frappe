name: Update All Branches
on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: write
  workflows: write

jobs:
  update-branches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update All Branches from Upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- CONFIGURATION ---
          UPSTREAM_URL="https://github.com/frappe/frappe.git"
          
          echo "ðŸš€ Starting Branch Update Process..."

          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # 1. SAVE CUSTOM WORKFLOWS
          echo "ðŸ“¦ Saving custom workflows..."
          mkdir -p /tmp/custom_workflows
          find .github/workflows -name '*.yml' -exec cp {} /tmp/custom_workflows/ \; 2>/dev/null || echo "No workflows to save"

          # 2. SETUP UPSTREAM
          echo "ðŸ”— Setting up upstream repository..."
          git remote remove upstream 2>/dev/null || true
          git remote add upstream $UPSTREAM_URL
          git fetch upstream

          # 3. IDENTIFY TARGET BRANCHES
          echo "ðŸ” Identifying branches to update..."
          TARGET_BRANCHES=$(git branch -r | grep 'upstream/' | grep -v 'HEAD' | grep -E 'upstream/develop$|upstream/version-[0-9]+$|upstream/v[0-9]+$' | sed 's/upstream\///g')

          if [ -z "$TARGET_BRANCHES" ]; then
            echo "âš ï¸ No target branches found to update"
            exit 0
          fi

          echo "ðŸ“‹ Branches to update:"
          echo "$TARGET_BRANCHES"

          # 4. UPDATE EACH BRANCH
          for BRANCH in $TARGET_BRANCHES; do
             # Trim whitespace
             BRANCH="${BRANCH#"${BRANCH%%[![:space:]]*}"}"
             BRANCH="${BRANCH%"${BRANCH##*[![:space:]]}"}"
             if [ -z "$BRANCH" ]; then continue; fi
             
             echo ""
             echo "ðŸ”§ Processing branch: $BRANCH"
             
             # Clean working directory
             git reset --hard
             git clean -fd

             # Check out the upstream branch
             echo "  â†“ Fetching latest from upstream/$BRANCH..."
             git checkout -B $BRANCH upstream/$BRANCH
             
             # Restore custom workflows
             echo "  ðŸ“¥ Restoring custom workflows..."
             mkdir -p .github/workflows
             find /tmp/custom_workflows -name '*.yml' -exec cp {} .github/workflows/ \; 2>/dev/null || echo "  No custom workflows to restore"
             
             # Check if there are changes to commit
             if [ -n "$(git status --porcelain)" ]; then
               git add .github/workflows/
               git commit -m "Update branch $BRANCH from upstream" || echo "  No changes to commit"
             fi
             
             # Push to origin
             echo "  â†‘ Pushing to origin/$BRANCH..."
             git push -f origin $BRANCH
             
             echo "  âœ… Branch $BRANCH updated successfully"
          done

          echo ""
          echo "ðŸŽ‰ All branches updated successfully!"
