name: Update All Branches
on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: write

jobs:
  update-branches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update All Branches from Upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- CONFIGURATION ---
          UPSTREAM_URL="https://github.com/frappe/frappe.git"

          echo "üöÄ Starting Branch Update Process..."

          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

          # 1. SETUP UPSTREAM
          echo "üîó Setting up upstream repository..."
          git remote remove upstream 2>/dev/null || true
          git remote add upstream $UPSTREAM_URL
          git fetch upstream

          # 2. IDENTIFY TARGET BRANCHES
          echo "üîç Identifying branches to update..."
          TARGET_BRANCHES=$(git branch -r | grep 'upstream/' | grep -v 'HEAD' | \
            grep -E 'upstream/develop$|upstream/version-[0-9]+$|upstream/v[0-9]+$' | \
            sed 's/upstream\///g')

          if [ -z "$TARGET_BRANCHES" ]; then
            echo "‚ö†Ô∏è No target branches found to update"
            exit 0
          fi

          echo "üìã Branches to update:"
          echo "$TARGET_BRANCHES"

          # 3. UPDATE EACH BRANCH
          for BRANCH in $TARGET_BRANCHES; do
             # Trim whitespace
             BRANCH="${BRANCH#"${BRANCH%%[![:space:]]*}"}"
             BRANCH="${BRANCH%"${BRANCH##*[![:space:]]}"}"
             if [ -z "$BRANCH" ]; then continue; fi

             echo ""
             echo "üîß Processing branch: $BRANCH"

             # Clean working directory
             git reset --hard
             git clean -fd

             # Save our custom workflows before checking out upstream
             echo "  üíæ Saving custom workflows..."
             mkdir -p /tmp/custom_workflows
             if [ -d ".github/workflows" ]; then
               cp -r .github/workflows/* /tmp/custom_workflows/ 2>/dev/null || true
             fi

             # Check out the upstream branch
             echo "  ‚Üì Fetching latest from upstream/$BRANCH..."
             git checkout -B $BRANCH upstream/$BRANCH

             # Remove upstream workflow files to avoid permission issues
             echo "  üóëÔ∏è Removing upstream workflow files..."
             git rm -rf .github/workflows 2>/dev/null || true
             rm -rf .github/workflows 2>/dev/null || true

             # Restore our custom workflows
             echo "  ‚ôªÔ∏è Restoring custom workflows..."
             mkdir -p .github/workflows
             cp /tmp/custom_workflows/* .github/workflows/ 2>/dev/null || true
             git add .github/workflows/

             # Commit the workflow changes if any
             git commit -m "Preserve custom workflows for $BRANCH" || echo "  ‚ÑπÔ∏è No workflow changes needed"

             # Push to origin
             echo "  ‚Üë Pushing to origin/$BRANCH..."
             git push -f origin $BRANCH

             echo "  ‚úÖ Branch $BRANCH updated successfully"
          done

          echo ""
          echo "üéâ All branches updated successfully!"
