name: 2. App Rebrander
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply-rebrand:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Apply New Name
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- NOMI ---
          OLD="Frappe Framework"
          NEW="Frameworks"
          
          echo "üé® Avvio Rebrand: $OLD -> $NEW"

          git config --global user.name 'Bot'
          git config --global user.email 'bot@noreply.com'

          # Cerchiamo i rami locali (gi√† aggiornati dall'altro script)
          # Lavoriamo su develop e version-*
          BRANCHES=$(git branch -r | grep 'origin/' | grep -v 'HEAD' | grep -E 'develop|version-' | sed 's/origin\///g')

          for BRANCH in $BRANCHES; do
             BRANCH=$(echo "$BRANCH" | xargs)
             if [ -z "$BRANCH" ]; then continue; fi
             
             echo "üñåÔ∏è Rebranding Ramo: $BRANCH"
             
             git checkout $BRANCH
             
             # 1. SOSTITUZIONE TESTUALE
             find . -type f \( -name "*.js" -o -name "*.vue" -o -name "*.html" \) -not -path "*/node_modules/*" -exec sed -i "s/$OLD/$NEW/g" {} +
             
             # 2. PATCH TRANSLATE.JS
             if [ -f "frappe/public/js/frappe/translate.js" ]; then
                # Verifica se la patch √® gi√† presente per evitare duplicati
                if ! grep -q "//FIX" "frappe/public/js/frappe/translate.js"; then
                   printf "\n\n//FIX\nsetTimeout(()=>{const r=(t)=>t.replace(/$OLD/g,\"$NEW\");const w=document.createTreeWalker(document.body,4);let n;while(n=w.nextNode())if(n.nodeValue&&n.nodeValue.includes(\"$OLD\"))n.nodeValue=r(n.nodeValue);},500);" >> frappe/public/js/frappe/translate.js
                fi
             fi
             
             git commit -a -m "Rebrand Applied: $NEW" || echo "Gi√† rebrandizzato"
             git push origin $BRANCH
          done
